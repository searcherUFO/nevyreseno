<!doctype html>
<html lang="cs">
<head>
    <meta charset="utf-8">
    <title>ETH Mobile Scanner (Stay Awake)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: 'Consolas', monospace; }
        .main-card { background-color: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; }
        .total-display { font-size: 2rem; color: #58a6ff; font-weight: bold; }
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; background: #21262d; margin-right: 5px; }
        textarea { background-color: #010409 !important; color: #58a6ff !important; border: 1px solid #30363d !important; height: 120px; font-size: 12px; }
        /* Skryté video pro hack */
        #noSleepVideo { position: absolute; left: -999px; top: -999px; width: 1px; height: 1px; opacity: 0; }
    </style>
</head>
<body>

<div class="container py-3">
    <div class="main-card shadow-lg mb-3">
        <h4 class="fw-bold mb-3">ETH <span style="color:#58a6ff">UltraVigil</span> Scanner</h4>
        
        <div class="mb-3">
            <span id="lockStatus" class="status-pill text-danger">OBRAZOVKA: VYPNUTA</span>
            <span id="engineStatus" class="status-pill text-primary">KLIDOVÝ STAV</span>
        </div>

        <div class="text-end mb-3">
            <small class="text-muted d-block">CELKEM NAJDENO</small>
            <div class="total-display"><span id="totalEth">0.0000</span> ETH</div>
        </div>

        <input type="file" id="fileInput" class="form-control mb-3" accept=".txt">
        <textarea id="addressInput" class="form-control mb-3" placeholder="Vložte adresy..."></textarea>

        <button id="runBtn" class="btn btn-primary btn-lg w-100 fw-bold py-3" onclick="bootScanner()">SPUSTIT A ZAMKNOUT DISPLEJ</button>
        <div id="progressInfo" class="text-center mt-3 small text-muted"></div>
    </div>

    <!-- Nalezené peněženky -->
    <div id="foundArea" class="d-none">
        <div class="main-card p-0 overflow-hidden">
            <table class="table table-dark table-sm mb-0">
                <tbody id="foundBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Video Element pro NoSleep Hack -->
<video id="noSleepVideo" playsinline loop muted></video>

<script>
const ALCHEMY_URL = "https://eth-mainnet.g.alchemy.com/v2/Aez99WycUrG8jncryndbA";

let wakeLock = null;
const video = document.getElementById('noSleepVideo');

// 1. VIDEO HACK (Pro iOS a starší Androidy)
// Malý kousek Base64 videa (prázdné video o délce 0.1s)
const noSleepVideoSrc = "data:video/webm;base64,GkXfo0AgQoaBAULBaXf38gEAf4BAK6o98gSAgEAVbu70nPGSNoK77u6T8pS9u7uT8pS9u7uT8pS9u7uSAf4BAK6o98gSAgEAVbu70nPGSNoK77u6T8pS9u7uT8pS9u7uT8pS9u7uQ";

async function enableNoSleep() {
    try {
        video.src = noSleepVideoSrc;
        await video.play();
        document.getElementById('lockStatus').innerText = "OBRAZOVKA: ZAMČENA (VIDEO)";
        document.getElementById('lockStatus').className = "status-pill text-success";
    } catch (err) {
        console.log("Video hack selhal, zkusíme WakeLock API...");
    }
}

// 2. NATIVNÍ WAKELOCK (Pro moderní Chrome/Android)
async function enableWakeLock() {
    if ('wakeLock' in navigator) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            document.getElementById('lockStatus').innerText = "OBRAZOVKA: ZAMČENA (API)";
        } catch (err) {
            console.error(err);
        }
    }
}

async function bootScanner() {
    // KLÍČOVÉ: Musíme aktivovat video i wake lock hned po kliknutí (User Interaction)
    await enableNoSleep();
    await enableWakeLock();
    
    startEngine();
}

async function startEngine() {
    const btn = document.getElementById('runBtn');
    const fileInput = document.getElementById('fileInput');
    const textArea = document.getElementById('addressInput');
    const status = document.getElementById('progressInfo');
    const foundBody = document.getElementById('foundBody');
    const totalDisp = document.getElementById('totalEth');

    let rawInput = "";
    if (fileInput.files.length > 0) {
        const reader = new FileReader();
        rawInput = await new Promise(r => {
            reader.onload = (e) => r(e.target.result);
            reader.readAsText(fileInput.files[0]);
        });
    } else {
        rawInput = textArea.value;
    }

    const addresses = rawInput.split(/[\n, \r]+/)
        .map(a => a.trim().toLowerCase())
        .filter(a => a.startsWith('0x') && a.length === 42);

    if (addresses.length === 0) return alert("Žádné adresy!");

    btn.disabled = true;
    let totalWei = BigInt(0);
    const BATCH_SIZE = 100;

    for (let i = 0; i < addresses.length; i += BATCH_SIZE) {
        const chunk = addresses.slice(i, i + BATCH_SIZE);
        status.innerText = `Sken: ${i + chunk.length} / ${addresses.length}`;

        try {
            const payload = chunk.map((addr, idx) => ({ jsonrpc: "2.0", id: idx, method: "eth_getBalance", params: [addr, "latest"] }));
            const res = await fetch(ALCHEMY_URL, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload) 
            });
            const data = await res.json();

            if (Array.isArray(data)) {
                data.forEach((d, idx) => {
                    const wei = BigInt(d.result || "0x0");
                    if (wei > 0n) {
                        totalWei += wei;
                        document.getElementById('foundArea').classList.remove('d-none');
                        foundBody.insertAdjacentHTML('afterbegin', `
                            <tr>
                                <td class="ps-2 py-1 small">${chunk[idx].substring(0,10)}...</td>
                                <td class="text-end pe-2 py-1 text-success fw-bold">${(Number(wei)/1e18).toFixed(4)}</td>
                            </tr>
                        `);
                    }
                });
                totalDisp.innerText = (Number(totalWei)/1e18).toFixed(4);
            }
        } catch (e) {
            await new Promise(r => setTimeout(r, 1000));
            i -= BATCH_SIZE;
        }
        
        // Důležité pro mobilní prohlížeč, aby "dýchal"
        await new Promise(r => setTimeout(r, 50));
    }

    // Po dokončení uvolnit
    if (wakeLock) wakeLock.release();
    video.pause();
    document.getElementById('lockStatus').innerText = "DOKONČENO";
    btn.disabled = false;
}

// Pokud uživatel přepne kartu a vrátí se, musíme lock obnovit
document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
        wakeLock = await navigator.wakeLock.request('screen');
    }
});
</script>
</body>
</html>
